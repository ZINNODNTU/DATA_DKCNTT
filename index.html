<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hệ thống Quản lý Sinh viên Pro</title>
    
    <!-- Font: Inter (Font hiện đại hơn cho Web App) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Excel Library -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            /* Modern Color Palette */
            --primary: #3b82f6;       /* Blue 500 */
            --primary-dark: #2563eb;  /* Blue 600 */
            --primary-light: #eff6ff; /* Blue 50 */
            
            --success: #10b981;       /* Emerald 500 */
            --success-bg: #ecfdf5;
            
            --warning: #f59e0b;       /* Amber 500 */
            --warning-bg: #fffbeb;
            
            --danger: #ef4444;        /* Red 500 */
            --danger-bg: #fef2f2;
            
            --bg-body: #f3f4f6;       /* Gray 100 */
            --surface: #ffffff;
            
            --text-main: #1f2937;     /* Gray 800 */
            --text-secondary: #6b7280;/* Gray 500 */
            
            --border: #e5e7eb;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            padding-bottom: 60px; 
            font-size: 14px;
            line-height: 1.5;
        }

        /* --- SCROLLBAR CUSTOMIZATION --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- HEADER --- */
        .top-bar {
            background: var(--surface);
            padding: 16px 0;
            position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        
        .brand { 
            font-size: 20px; font-weight: 700; color: var(--primary-dark); 
            display: flex; align-items: center; gap: 12px; 
        }
        .brand-icon {
            width: 40px; height: 40px; background: var(--primary-light);
            color: var(--primary); border-radius: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 18px;
        }

        .update-info { 
            font-size: 12px; font-weight: 500; color: var(--text-secondary);
            background: var(--bg-body); padding: 6px 12px; border-radius: 20px;
            display: flex; align-items: center; gap: 6px;
        }

        /* --- DASHBOARD STATS --- */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin: 24px 0;
        }
        .stat-card {
            background: var(--surface); padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); border: 1px solid var(--border);
            position: relative; overflow: hidden; transition: var(--transition);
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
        
        .stat-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .stat-icon { 
            width: 36px; height: 36px; border-radius: 8px; display: flex; 
            align-items: center; justify-content: center; font-size: 16px; 
        }
        .stat-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 28px; font-weight: 800; color: var(--text-main); line-height: 1; }
        
        /* Color variants for Stats */
        .sc-blue .stat-icon { background: var(--primary-light); color: var(--primary); }
        .sc-red .stat-icon { background: var(--danger-bg); color: var(--danger); }
        .sc-yellow .stat-icon { background: var(--warning-bg); color: var(--warning); }
        .sc-green .stat-icon { background: var(--success-bg); color: var(--success); }

        /* --- NAVIGATION TABS --- */
        .nav-wrapper {
            background: var(--surface); border-radius: var(--radius); padding: 6px;
            box-shadow: var(--shadow); margin-bottom: 24px; border: 1px solid var(--border);
            display: flex; overflow-x: auto; scrollbar-width: none;
        }
        .nav-item {
            flex: 1; text-align: center; padding: 10px 16px; cursor: pointer;
            font-weight: 500; color: var(--text-secondary); border-radius: 10px;
            transition: var(--transition); white-space: nowrap; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .nav-item:hover { background: var(--bg-body); color: var(--text-main); }
        .nav-item.active { background: var(--primary); color: white; font-weight: 600; box-shadow: 0 4px 6px -2px rgba(37, 99, 235, 0.4); }
        
        /* Specific Styles for Tab Colors when Active */
        .nav-item.danger-tab.active { background: var(--danger); box-shadow: 0 4px 6px -2px rgba(239, 68, 68, 0.4); }

        /* --- FILTERS SECTION --- */
        .filter-section {
            background: var(--surface); padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 24px; border: 1px solid var(--border);
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 16px; align-items: end;
        }
        
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-group label { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
        
        .form-control {
            width: 100%; height: 42px; padding: 0 14px; 
            border: 1px solid var(--border); border-radius: 10px;
            font-size: 14px; color: var(--text-main); background: #fff;
            transition: var(--transition); outline: none; appearance: none;
        }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        select.form-control { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; background-size: 16px; padding-right: 40px; }

        .search-group { grid-column: span 2; }
        @media (max-width: 900px) { .search-group { grid-column: span 1; } }

        .action-group { display: flex; gap: 10px; align-items: flex-end; }
        
        .count-badge {
            height: 42px; padding: 0 16px; border-radius: 10px;
            background: var(--bg-body); color: var(--text-main); font-weight: 600;
            display: flex; align-items: center; border: 1px solid var(--border);
            white-space: nowrap;
        }

        .btn {
            height: 42px; padding: 0 20px; border: none; border-radius: 10px;
            font-weight: 600; font-size: 14px; cursor: pointer; color: white;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: var(--transition); box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap;
        }
        .btn:active { transform: scale(0.97); }
        .btn-green { background: var(--success); } .btn-green:hover { background: #059669; }
        .btn-red { background: var(--danger); } .btn-red:hover { background: #dc2626; }
        .btn-blue { background: var(--primary); } .btn-blue:hover { background: #1d4ed8; }

        /* --- TABLE STYLE --- */
        .table-wrapper {
            background: var(--surface); border-radius: var(--radius);
            box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border);
            position: relative;
        }
        .table-scroll { overflow-x: auto; max-height: 70vh; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; }
        
        thead th {
            background: #f8fafc; color: var(--text-secondary); font-size: 12px; 
            font-weight: 600; text-transform: uppercase; padding: 16px; text-align: left;
            position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border);
        }
        
        tbody td {
            padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px;
            vertical-align: middle; color: var(--text-main); white-space: nowrap;
            transition: background 0.1s;
        }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background-color: var(--primary-light); }
        
        .wrap-text { white-space: normal; line-height: 1.4; min-width: 250px; }
        .mono-font { font-family: 'SF Mono', 'Roboto Mono', monospace; font-weight: 500; color: var(--text-secondary); letter-spacing: -0.5px; }

        /* Status Tags */
        .tag { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
        .tag-dot { width: 6px; height: 6px; border-radius: 50%; }

        .st-ok { background: var(--success-bg); color: var(--success); border: 1px solid #a7f3d0; } 
        .st-ok .tag-dot { background: var(--success); }
        
        .st-warn { background: var(--warning-bg); color: #d97706; border: 1px solid #fde68a; } 
        .st-warn .tag-dot { background: #d97706; }
        
        .st-missing { background: var(--danger-bg); color: var(--danger); border: 1px solid #fecaca; } 
        .st-missing .tag-dot { background: var(--danger); }

        .gender-tag { padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .g-male { background: #dbeafe; color: #1e40af; }
        .g-female { background: #fce7f3; color: #be185d; }

        .vio-badge {
            width: 24px; height: 24px; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 12px; font-weight: 700;
            margin: 0 auto;
        }
        .vio-yes { background: var(--danger); color: white; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4); }
        .vio-no { color: #d1d5db; background: #f3f4f6; }

        /* --- LOADING SCREEN --- */
        #loading-screen {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 48px; height: 48px; border: 4px solid var(--border);
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.5, 0.1, 0.4, 0.9) infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- SUB VIEWS --- */
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .view-header {
            display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
            font-size: 18px; font-weight: 700; color: var(--text-main);
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 768px) {
            .container { padding: 0 12px; }
            .header-content { flex-direction: row; gap: 10px; }
            .brand span { display: none; } /* Hide text logo on small mobile */
            .brand-icon { width: 32px; height: 32px; font-size: 16px; }
            
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
            .stat-card { padding: 16px; }
            .stat-value { font-size: 22px; }
            
            .filter-section { display: flex; flex-direction: column; gap: 12px; align-items: stretch; padding: 16px; }
            .search-group { width: 100%; }
            .action-group { flex-direction: column; }
            .btn, .count-badge { width: 100%; }

            /* Fix input zoom on iOS */
            input, select, textarea { font-size: 16px !important; }
            
            .nav-item { padding: 10px; font-size: 13px; }
        }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div style="font-weight: 600; color: var(--text-main); font-size: 15px;">Đang đồng bộ dữ liệu...</div>
    </div>

    <!-- HEADER -->
    <div class="top-bar">
        <div class="container header-content">
            <div class="brand">
                <div class="brand-icon"><i class="fa-solid fa-graduation-cap"></i></div>
                <span>QUẢN LÝ ĐOÀN VIÊN</span>
            </div>
            <div class="update-info" id="lastUpdate">
                <i class="fa-regular fa-clock"></i> Đang tải...
            </div>
        </div>
    </div>

    <div class="container">
        
        <!-- DASHBOARD STATS -->
        <div class="stats-grid">
            <div class="stat-card sc-blue">
                <div class="stat-header">
                    <span class="stat-title">Tổng SV</span>
                    <div class="stat-icon"><i class="fa-solid fa-users"></i></div>
                </div>
                <div class="stat-value" id="totalSV">0</div>
            </div>
            <div class="stat-card sc-red">
                <div class="stat-header">
                    <span class="stat-title">Vi Phạm</span>
                    <div class="stat-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                </div>
                <div class="stat-value" id="totalVio">0</div>
            </div>
            <div class="stat-card sc-yellow">
                <div class="stat-header">
                    <span class="stat-title">Khó Khăn</span>
                    <div class="stat-icon"><i class="fa-solid fa-hand-holding-heart"></i></div>
                </div>
                <div class="stat-value" id="totalDiff">0</div>
            </div>
            <div class="stat-card sc-green">
                <div class="stat-header">
                    <span class="stat-title">Đã Nộp Sổ</span>
                    <div class="stat-icon"><i class="fa-solid fa-book-bookmark"></i></div>
                </div>
                <div class="stat-value" id="totalBook">0</div>
            </div>
        </div>

        <!-- NAVIGATION -->
        <div class="nav-wrapper">
            <div class="nav-item active" onclick="switchTab('list', this)">
                <i class="fa-solid fa-list-ul"></i> Tổng hợp
            </div>
            <div class="nav-item danger-tab" onclick="switchTab('violation', this)">
                <i class="fa-solid fa-circle-exclamation"></i> Vi phạm
            </div>
            <div class="nav-item" onclick="switchTab('difficulty', this)">
                <i class="fa-solid fa-heart"></i> Khó khăn
            </div>
            <div class="nav-item" onclick="switchTab('stats', this)">
                <i class="fa-solid fa-chart-pie"></i> Báo cáo
            </div>
        </div>

        <!-- VIEW 1: DANH SÁCH TỔNG HỢP -->
        <div id="listView" class="view-section active">
            
            <div class="filter-section">
                <div class="filter-group search-group">
                    <label>Tìm kiếm</label>
                    <input type="text" id="f_search" class="form-control" placeholder="Nhập tên hoặc MSSV..." oninput="applyFilters()">
                </div>

                <div class="filter-group">
                    <label>Chi đoàn</label>
                    <select id="f_class" class="form-control" onchange="applyFilters()">
                        <option value="ALL">Tất cả lớp</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Sổ Đoàn</label>
                    <select id="f_status" class="form-control" onchange="applyFilters()">
                        <option value="ALL">Tất cả trạng thái</option>
                        <option value="OK">Đã nộp đầy đủ</option>
                        <option value="X">Thiếu thông tin</option>
                        <option value="MISSING">Chưa nộp</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Giới tính</label>
                    <select id="f_gender" class="form-control" onchange="applyFilters()">
                        <option value="ALL">Tất cả</option>
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                    </select>
                </div>

                <div class="filter-group action-group">
                    <div class="count-badge">
                        <span id="countDisplay">SL: 0</span>
                    </div>
                    <button class="btn btn-green" onclick="exportExcel('list')">
                        <i class="fa-solid fa-file-excel"></i> Xuất Excel
                    </button>
                </div>
            </div>

            <!-- TABLE -->
            <div class="table-wrapper">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th width="120">MSSV</th>
                                <th width="200">Họ và Tên</th>
                                <th width="100">Lớp</th>
                                <th width="90">Giới tính</th>
                                <th width="160">Trạng thái Sổ</th>
                                <th width="80" style="text-align: center;">Lỗi</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW 2: VI PHẠM -->
        <div id="violationView" class="view-section">
            <div class="view-header" style="color: var(--danger);">
                <i class="fa-solid fa-triangle-exclamation"></i> Danh sách Vi Phạm (HK2_2025_2026)
            </div>
            <div class="filter-section" style="display: flex; justify-content: flex-end; padding: 12px;">
                <button class="btn btn-red" onclick="exportExcel('violation')"><i class="fa-solid fa-file-export"></i> Tải danh sách vi phạm</button>
            </div>
            <div class="table-wrapper">
                <div class="table-scroll">
                    <table>
                        <thead><tr><th width="50">STT</th><th width="120">MSSV</th><th width="200">Họ và Tên</th><th width="100">Lớp</th><th>Nội dung vi phạm</th></tr></thead>
                        <tbody id="tbodyViolation"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW 3: KHÓ KHĂN -->
        <div id="difficultyView" class="view-section">
            <div class="view-header" style="color: var(--warning);">
                <i class="fa-solid fa-hand-holding-heart"></i> Hoàn cảnh Khó khăn
            </div>
            <div class="filter-section" style="display: flex; justify-content: flex-end; padding: 12px;">
                <button class="btn btn-blue" style="background: var(--warning);" onclick="exportExcel('difficulty')"><i class="fa-solid fa-file-csv"></i> Tải danh sách khó khăn</button>
            </div>
            <div class="table-wrapper">
                <div class="table-scroll">
                    <table>
                        <thead><tr><th width="120">MSSV</th><th width="200">Họ và Tên</th><th width="100">Lớp</th><th>Mô tả hoàn cảnh</th></tr></thead>
                        <tbody id="tbodyDifficulty"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW 4: THỐNG KÊ -->
        <div id="statsView" class="view-section">
            <div class="view-header" style="color: var(--primary);">
                <i class="fa-solid fa-chart-pie"></i> Báo cáo tổng hợp
            </div>
            <div class="filter-section" style="display: flex; justify-content: flex-end; padding: 12px;">
                <button class="btn btn-blue" onclick="exportExcel('stats')"><i class="fa-solid fa-download"></i> Tải Báo Cáo</button>
            </div>
            <div class="table-wrapper">
                <div class="table-scroll">
                    <table id="statsTable">
                        <thead>
                            <tr>
                                <th style="text-align: center;" width="60">STT</th>
                                <th>Chi đoàn</th>
                                <th style="text-align: center;">Tổng SV</th>
                                <th style="text-align: center;">Nam</th>
                                <th style="text-align: center;">Nữ</th>
                                <th style="text-align: center;">Có Lỗi</th>
                                <th style="text-align: center;">Đã nộp</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyStats"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

<script>
    // --- CONFIGURATION ---
    const URLS = {
        STUDENTS: "https://opensheet.elk.sh/1hd1-8lo1DxPOGrPwizlvcF7xPdyu9_dzvzwyziGjmfE/Câu trả lời biểu mẫu 1",
        BOOKS: "https://opensheet.elk.sh/12BNuvpjajh81Dsuuo_6NdROegNgu6reCp8KYttTnprc/TONG HOP",
        VIOLATIONS: "https://opensheet.elk.sh/110EmYT7ecjpCMw-LcLtTDx0iYpWraR8jwbAIK_9Jyew/VIPHAM"
    };

    const COLS = {
        MSSV: "Mã số sinh viên:", NAME: "Họ Tên:", CLASS: "Chi đoàn trực thuộc:", GENDER: "Giới tính:",
        HARD: "Bạn có thuộc diện hoàn cảnh khó khăn không?", FAMILY: "Tóm tắt hoàn cảnh gia đình:",
        BOOK_MSSV: "MSSV", BOOK_STATUS: "Đã nộp sổ Đoàn",
        VIO_MSSV: "MSSV", VIO_CONTENT: "Ghi chú"
    };

    let globalData = [];

    // --- UTILITIES ---
    const formatName = (str) => str ? str.toLowerCase().replace(/(?:^|\s)\S/g, a => a.toUpperCase()) : "";
    
    // --- MAIN FUNCTION ---
    async function loadData() {
        try {
            const [students, books, violations] = await Promise.all([
                fetch(URLS.STUDENTS).then(r => r.json()),
                fetch(URLS.BOOKS).then(r => r.json()),
                fetch(URLS.VIOLATIONS).then(r => r.json().catch(() => []))
            ]);

            // Process Data
            const vioMap = {};
            violations.forEach(v => {
                const mssv = v[COLS.VIO_MSSV]?.toString().trim();
                const content = v[COLS.VIO_CONTENT];
                if(mssv && content) {
                    if(!vioMap[mssv]) vioMap[mssv] = [];
                    if(!vioMap[mssv].includes(content)) vioMap[mssv].push(content);
                }
            });

            const bookMap = {};
            books.forEach(b => {
                const mssv = b[COLS.BOOK_MSSV]?.toString().trim();
                if(mssv) bookMap[mssv] = b[COLS.BOOK_STATUS];
            });

            const seen = new Set();
            globalData = [];

            students.forEach(s => {
                const mssv = s[COLS.MSSV]?.toString().trim();
                if (!mssv || seen.has(mssv)) return;
                seen.add(mssv);

                let rawBook = bookMap[mssv] || "";
                let check = rawBook.toString().trim().toLowerCase();
                let bCode = "MISSING", bLabel = "Chưa nộp";

                if (check === "x") { bCode = "X"; bLabel = "Thiếu tin"; }
                else if (check.length > 0) { bCode = "OK"; bLabel = rawBook; }

                globalData.push({
                    mssv: mssv,
                    name: formatName(s[COLS.NAME]),
                    class: s[COLS.CLASS],
                    gender: s[COLS.GENDER],
                    isHard: s[COLS.HARD] === "Có",
                    family: s[COLS.FAMILY],
                    bookCode: bCode,
                    bookLabel: bLabel,
                    violations: vioMap[mssv] || [],
                });
            });

            updateDashboard();
            populateClassDropdown();
            applyFilters();
            renderSubViews();
            
            document.getElementById("loading-screen").style.opacity = "0";
            setTimeout(() => { document.getElementById("loading-screen").style.display = "none"; }, 500);
            
            document.getElementById("lastUpdate").innerHTML = `<i class="fa-regular fa-clock"></i> Cập nhật: ${new Date().toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}`;

        } catch (e) {
            console.error(e);
            alert("Lỗi kết nối! Vui lòng tải lại trang.");
            document.getElementById("loading-screen").style.display = "none";
        }
    }

    // --- LOGIC FUNCTIONS ---
    function updateDashboard() {
        // Animation numbers
        const animateValue = (id, end) => {
            const obj = document.getElementById(id);
            let start = 0;
            if(end === 0) { obj.innerText = 0; return; }
            let duration = 1000;
            let range = end - start;
            let current = start;
            let increment = end > start ? 1 : -1;
            let stepTime = Math.abs(Math.floor(duration / range));
            let timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) clearInterval(timer);
            }, Math.max(stepTime, 10));
        };

        animateValue("totalSV", globalData.length);
        animateValue("totalVio", globalData.filter(d => d.violations.length > 0).length);
        animateValue("totalDiff", globalData.filter(d => d.isHard).length);
        animateValue("totalBook", globalData.filter(d => d.bookCode === "OK").length);
    }

    function populateClassDropdown() {
        const classes = [...new Set(globalData.map(d => d.class).filter(Boolean))].sort();
        const sel = document.getElementById("f_class");
        classes.forEach(c => sel.add(new Option(c, c)));
    }

    function applyFilters() {
        const fClass = document.getElementById("f_class").value;
        const fStatus = document.getElementById("f_status").value;
        const fGender = document.getElementById("f_gender").value;
        const fSearch = document.getElementById("f_search").value.toLowerCase().trim();

        const filtered = globalData.filter(item => {
            return (fClass === "ALL" || item.class === fClass) &&
                   (fStatus === "ALL" || item.bookCode === fStatus) &&
                   (fGender === "ALL" || item.gender === fGender) &&
                   (item.name.toLowerCase().includes(fSearch) || item.mssv.includes(fSearch));
        });

        document.getElementById("countDisplay").innerHTML = `Hiển thị: <b>${filtered.length}</b>`;
        const tbody = document.getElementById("tbodyList");
        tbody.innerHTML = "";

        if(filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-secondary)"><i class="fa-solid fa-inbox" style="font-size:30px; margin-bottom:10px; display:block"></i>Không tìm thấy dữ liệu phù hợp</td></tr>`;
            return;
        }

        const frag = document.createDocumentFragment();
        filtered.forEach(item => {
            let statusClass = item.bookCode === 'OK' ? 'st-ok' : (item.bookCode === 'X' ? 'st-warn' : 'st-missing');
            let genderClass = item.gender === 'Nam' ? 'g-male' : 'g-female';
            let vioCount = item.violations.length;
            let vioContent = vioCount > 0 
                ? `<div class="vio-badge vio-yes">${vioCount}</div>` 
                : `<div class="vio-badge vio-no"><i class="fa-solid fa-check"></i></div>`;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="mono-font" style="color:var(--primary-dark)">${item.mssv}</td>
                <td style="font-weight:600">${item.name}</td>
                <td>${item.class}</td>
                <td><span class="gender-tag ${genderClass}">${item.gender}</span></td>
                <td><span class="tag ${statusClass}"><span class="tag-dot"></span>${item.bookLabel}</span></td>
                <td style="text-align:center">${vioContent}</td>
            `;
            frag.appendChild(tr);
        });
        tbody.appendChild(frag);
    }

    function renderSubViews() {
        // Vi Phạm
        const vList = globalData.filter(d => d.violations.length > 0);
        const tbV = document.getElementById("tbodyViolation");
        tbV.innerHTML = "";
        vList.forEach((d, i) => {
            tbV.innerHTML += `<tr><td style="text-align:center; color:var(--text-secondary)">${i+1}</td><td class="mono-font">${d.mssv}</td><td style="font-weight:600">${d.name}</td><td>${d.class}</td><td class="wrap-text" style="color:var(--danger)">${d.violations.join(", ")}</td></tr>`;
        });

        // Khó khăn
        const dList = globalData.filter(d => d.isHard);
        const tbD = document.getElementById("tbodyDifficulty");
        tbD.innerHTML = "";
        dList.forEach(d => {
            tbD.innerHTML += `<tr><td class="mono-font">${d.mssv}</td><td style="font-weight:600">${d.name}</td><td>${d.class}</td><td class="wrap-text">${d.family}</td></tr>`;
        });

        // Thống kê
        const map = {};
        globalData.forEach(s => {
            const c = s.class || "Khác";
            if(!map[c]) map[c] = { total:0, nam:0, nu:0, vio:0, book:0 };
            map[c].total++;
            if(s.gender === "Nam") map[c].nam++; else map[c].nu++;
            if(s.violations.length > 0) map[c].vio++;
            if(s.bookCode === "OK") map[c].book++;
        });

        const tbS = document.getElementById("tbodyStats");
        tbS.innerHTML = "";
        Object.keys(map).sort().forEach((c, i) => {
            const d = map[c];
            tbS.innerHTML += `
                <tr>
                    <td style="text-align:center">${i+1}</td>
                    <td style="font-weight:700">${c}</td>
                    <td style="text-align:center; font-weight:600">${d.total}</td>
                    <td style="text-align:center; color:#1e40af">${d.nam}</td>
                    <td style="text-align:center; color:#be185d">${d.nu}</td>
                    <td style="text-align:center; font-weight:700; color:${d.vio>0 ? 'var(--danger)' : '#e5e7eb'}">${d.vio}</td>
                    <td style="text-align:center; font-weight:700; color:var(--success)">${d.book}</td>
                </tr>`;
        });
    }

    function switchTab(tab, btn) {
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(tab + 'View').classList.add('active');
        
        if(window.innerWidth < 768) {
             // Smooth scroll adjust for mobile
        }
    }

    function exportExcel(type) {
        const wb = XLSX.utils.book_new();
        let ws, name;

        const fClass = document.getElementById("f_class").value;
        const fStatus = document.getElementById("f_status").value;
        const fGender = document.getElementById("f_gender").value;
        const fSearch = document.getElementById("f_search").value.toLowerCase().trim();

        const getFilteredData = (sourceData) => {
            return sourceData.filter(item => {
                const matchClass = (fClass === "ALL" || item.class === fClass);
                if (type === 'list') {
                    const matchStatus = (fStatus === "ALL" || item.bookCode === fStatus);
                    const matchGender = (fGender === "ALL" || item.gender === fGender);
                    const matchSearch = (item.name.toLowerCase().includes(fSearch) || item.mssv.includes(fSearch));
                    return matchClass && matchStatus && matchGender && matchSearch;
                }
                return matchClass; 
            });
        };

        const dataToExport = getFilteredData(globalData);

        if(type === 'list') {
            const data = dataToExport.map(s => ({ MSSV: s.mssv, "Họ Tên": s.name, "Lớp": s.class, "Giới tính": s.gender, "Sổ Đoàn": s.bookLabel, "SL Vi phạm": s.violations.length }));
            ws = XLSX.utils.json_to_sheet(data); name = "DS_TongHop";
        } else if(type === 'violation') {
            const vioList = dataToExport.filter(d => d.violations.length > 0);
            const data = vioList.map((s,i) => ({ STT: i+1, MSSV: s.mssv, "Họ Tên": s.name, "Lớp": s.class, "Nội dung": s.violations.join(", ") }));
            ws = XLSX.utils.json_to_sheet(data); name = "DS_ViPham";
        } else if(type === 'difficulty') {
            const diffList = dataToExport.filter(d => d.isHard);
            const data = diffList.map(s => ({ MSSV: s.mssv, "Họ Tên": s.name, "Lớp": s.class, "Hoàn cảnh": s.family }));
            ws = XLSX.utils.json_to_sheet(data); name = "DS_KhoKhan";
        } else {
            ws = XLSX.utils.table_to_sheet(document.getElementById("statsTable")); name = "BaoCao_SoLieu";
        }
        
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, name + ".xlsx");
    }

    window.onload = loadData;
</script>
</body>
</html>
